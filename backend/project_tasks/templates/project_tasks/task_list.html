<!-- templates/project_tasks/task_list.html -->
{% extends 'project_tasks/base.html' %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .search-bar {
        position: relative;
    }
    .search-bar .bi-search {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #6c757d;
    }
    .search-bar input {
        padding-left: 35px;
    }
    .badge-count {
        font-size: 12px;
        background: rgba(0,0,0,0.1);
        color: #333;
        border-radius: 10px;
        padding: 2px 8px;
        margin-left: 5px;
    }
    .task-actions {
        display: none;
        position: absolute;
        bottom: 15px;
        right: 15px;
        z-index: 10;
    }
    .task-actions.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Project Tasks</h1>
        <div>
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus-lg me-1"></i> Add Task
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'new_internal_task' %}">Internal Task</a></li>
                    <li><a class="dropdown-item" href="{% url 'new_external_task' %}">External Task</a></li>
                </ul>
            </div>
            <!-- Removed bulk actions button -->
        </div>
    </div>
    
    <!-- Search and Filter Section -->
    <div class="filter-section mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="search-bar">
                    <i class="bi bi-search"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search tasks...">
                </div>
            </div>
            <div class="col-md-8">
                <div class="row g-2">
                    <div class="col-md-4">
                        <select id="statusFilter" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="canceled">Canceled</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select id="projectFilter" class="form-select">
                            <option value="">All Projects</option>
                            <!-- Projects will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex">
                            <select id="sortFilter" class="form-select">
                                <option value="deadline_asc">Deadline (Earliest)</option>
                                <option value="deadline_desc">Deadline (Latest)</option>
                                <option value="status">Status</option>
                                <option value="project">Project ID</option>
                            </select>
                            <button id="resetFilters" class="btn btn-outline-secondary ms-2" title="Reset Filters">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Task Type Tabs -->
    <div class="mb-4">
        <ul class="nav nav-tabs" id="taskTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-task-type="all">
                    All Tasks <span class="badge-count" id="all-count">{{ internal_tasks.count|add:external_tasks.count }}</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-task-type="internal">
                    Internal Tasks <span class="badge-count" id="internal-count">{{ internal_tasks.count }}</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-task-type="external">
                    External Tasks <span class="badge-count" id="external-count">{{ external_tasks.count }}</span>
                </button>
            </li>
        </ul>
    </div>
    
    <!-- Task List -->
    <div class="card">
        <div class="table-responsive position-relative">
            <!-- Removed bulk actions toolbar -->
            
            <table class="table table-hover mb-0" id="taskTable">
                <thead>
                    <tr>
                        <th width="30"><input type="checkbox" id="selectAll" /></th>
                        <th>Task ID</th>
                        <th>Project ID</th>
                        <th>Labor ID</th>
                        <th>Status</th>
                        <th>Deadline</th>
                        <th>Description</th>
                        <th width="80">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in internal_tasks %}
                    <tr class="task-row" data-task-type="internal" data-task-id="{{ task.intrnl_task_id }}" data-project-id="{{ task.intrnl_project_id }}" data-status="{{ task.intrnl_task_status }}" data-search-text="{{ task.intrnl_task_id }} {{ task.intrnl_project_id }} {{ task.intrnl_task_description|default:'' }}">
                        <td><input type="checkbox" class="task-checkbox" /></td>
                        <td>{{ task.intrnl_task_id }}</td>
                        <td>{{ task.intrnl_project_id }}</td>
                        <td>{{ task.intrnl_project_labor_id }}</td>
                        <td>
                            <span class="badge bg-{% if task.intrnl_task_status == 'completed' %}success{% elif task.intrnl_task_status == 'in_progress' %}primary{% elif task.intrnl_task_status == 'pending' %}warning{% else %}secondary{% endif %}">
                                {{ task.intrnl_task_status|title }}
                            </span>
                        </td>
                        <td>{{ task.intrnl_task_deadline }}</td>
                        <td>{{ task.intrnl_task_description|truncatechars:50 }}</td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="{% url 'task_detail' 'internal' task.intrnl_task_id %}">View</a></li>
                                    <li><a class="dropdown-item" href="{% url 'edit_task' 'internal' task.intrnl_task_id %}">Edit</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#">Delete</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    {% for task in external_tasks %}
                    <tr class="task-row" data-task-type="external" data-task-id="{{ task.task_id }}" data-project-id="{{ task.project_id }}" data-status="{{ task.task_status }}" data-search-text="{{ task.task_id }} {{ task.project_id }} {{ task.task_description|default:'' }}">
                        <td><input type="checkbox" class="task-checkbox" /></td>
                        <td>{{ task.task_id }}</td>
                        <td>{{ task.project_id }}</td>
                        <td>{{ task.project_labor_id }}</td>
                        <td>
                            <span class="badge bg-{% if task.task_status == 'completed' %}success{% elif task.task_status == 'in_progress' %}primary{% elif task.task_status == 'pending' %}warning{% else %}secondary{% endif %}">
                                {{ task.task_status|title }}
                            </span>
                        </td>
                        <td>{{ task.task_deadline }}</td>
                        <td>{{ task.task_description|truncatechars:50 }}</td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="{% url 'task_detail' 'external' task.task_id %}">View</a></li>
                                    <li><a class="dropdown-item" href="{% url 'edit_task' 'external' task.task_id %}">Edit</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#">Delete</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-5 d-none">
                <div class="py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <h5 class="mt-3">No tasks found</h5>
                    <p class="text-muted">Try adjusting your search or filter criteria</p>
                    <button id="clearFiltersBtn" class="btn btn-outline-primary mt-2">Clear Filters</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-4">
        <div>
            <span class="text-muted">Showing <span id="visibleCount">{{ internal_tasks.count|add:external_tasks.count }}</span> of {{ internal_tasks.count|add:external_tasks.count }} tasks</span>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination mb-0">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Task Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="statusChangeForm">
                    <div class="mb-3">
                        <label class="form-label">New Status</label>
                        <select class="form-select" id="newStatus">
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="canceled">Canceled</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChange">Apply</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load projects for filter dropdown
        Promise.all([
            fetch('/project-tasks/api/internal-projects/').then(res => res.json()),
            fetch('/project-tasks/api/external-projects/').then(res => res.json())
        ])
        .then(([internalProjects, externalProjects]) => {
            const projectFilter = document.getElementById('projectFilter');
            
            // Add internal projects
            internalProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = `internal-${project.intrnl_project_id}`;
                option.textContent = `${project.intrnl_project_id} (Internal)`;
                projectFilter.appendChild(option);
            });
            
            // Add external projects
            externalProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = `external-${project.project_id}`;
                option.textContent = `${project.project_id} (External)`;
                projectFilter.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading projects:', error));
        
        // Variables
        const taskTable = document.getElementById('taskTable');
        const taskRows = document.querySelectorAll('.task-row');
        const taskTabs = document.getElementById('taskTabs');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const projectFilter = document.getElementById('projectFilter');
        const sortFilter = document.getElementById('sortFilter');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const emptyState = document.getElementById('emptyState');
        const visibleCountEl = document.getElementById('visibleCount');
        const selectAll = document.getElementById('selectAll');
        const taskCheckboxes = document.querySelectorAll('.task-checkbox');
        
        // Handle tab switching
        taskTabs.addEventListener('click', function(e) {
            if (e.target.matches('[data-bs-toggle="tab"]')) {
                // Remove active class from all tabs
                taskTabs.querySelectorAll('.nav-link').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Add active class to clicked tab
                e.target.classList.add('active');
                
                // Apply filters
                applyFilters();
            }
        });
        
        // Handle search input
        searchInput.addEventListener('input', applyFilters);
        
        // Handle filter changes
        statusFilter.addEventListener('change', applyFilters);
        projectFilter.addEventListener('change', applyFilters);
        sortFilter.addEventListener('change', applyFilters);
        
        // Reset filters
        resetFiltersBtn.addEventListener('click', function() {
            searchInput.value = '';
            statusFilter.value = '';
            projectFilter.value = '';
            sortFilter.value = 'deadline_asc';
            applyFilters();
        });
        
        clearFiltersBtn.addEventListener('click', function() {
            resetFiltersBtn.click();
        });
        
        // Handle row click to navigate to task detail
        taskRows.forEach(row => {
            row.addEventListener('click', function(e) {
                // Don't navigate if checkbox or dropdown was clicked
                if (e.target.matches('input[type="checkbox"]') || 
                    e.target.closest('.dropdown') || 
                    e.target.closest('a')) {
                    return;
                }
                
                const taskType = this.getAttribute('data-task-type');
                const taskId = this.getAttribute('data-task-id');
                window.location.href = `/project-tasks/tasks/${taskType}/${taskId}/`;
            });
        });
        
        // Handle select all checkbox
        selectAll.addEventListener('change', function() {
            const isChecked = this.checked;
            const visibleCheckboxes = Array.from(taskCheckboxes).filter(checkbox => 
                checkbox.closest('tr').style.display !== 'none'
            );
            
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        });
        
        // Function to apply all filters
        function applyFilters() {
            const selectedTab = taskTabs.querySelector('.nav-link.active').getAttribute('data-task-type');
            const searchTerm = searchInput.value.toLowerCase();
            const selectedStatus = statusFilter.value;
            const selectedProject = projectFilter.value;
            const sortOption = sortFilter.value;
            
            let visibleCount = 0;
            
            // First filter the rows
            taskRows.forEach(row => {
                const taskType = row.getAttribute('data-task-type');
                const taskStatus = row.getAttribute('data-status');
                const projectId = row.getAttribute('data-project-id');
                const searchText = row.getAttribute('data-search-text').toLowerCase();
                
                // Filter by tab
                const matchesTab = selectedTab === 'all' || taskType === selectedTab;
                
                // Filter by search
                const matchesSearch = !searchTerm || searchText.includes(searchTerm);
                
                // Filter by status
                const matchesStatus = !selectedStatus || taskStatus === selectedStatus;
                
                // Filter by project
                const matchesProject = !selectedProject || 
                    (selectedProject === `${taskType}-${projectId}`);
                
                // Show/hide row based on filters
                const isVisible = matchesTab && matchesSearch && matchesStatus && matchesProject;
                row.style.display = isVisible ? '' : 'none';
                
                if (isVisible) {
                    visibleCount++;
                }
            });
            
            // Then sort the visible rows
            sortRows(sortOption);
            
            // Update visible count
            visibleCountEl.textContent = visibleCount;
            
            // Show/hide empty state
            emptyState.classList.toggle('d-none', visibleCount > 0);
            taskTable.classList.toggle('d-none', visibleCount === 0);
        }
        
        // Function to sort rows
        function sortRows(sortOption) {
            const tbody = taskTable.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Only sort visible rows
            const visibleRows = rows.filter(row => row.style.display !== 'none');
            
            visibleRows.sort((a, b) => {
                if (sortOption === 'deadline_asc') {
                    const dateA = new Date(a.cells[5].textContent);
                    const dateB = new Date(b.cells[5].textContent);
                    return dateA - dateB;
                } else if (sortOption === 'deadline_desc') {
                    const dateA = new Date(a.cells[5].textContent);
                    const dateB = new Date(b.cells[5].textContent);
                    return dateB - dateA;
                } else if (sortOption === 'status') {
                    const statusA = a.getAttribute('data-status');
                    const statusB = b.getAttribute('data-status');
                    return statusA.localeCompare(statusB);
                } else if (sortOption === 'project') {
                    const projectA = a.cells[2].textContent;
                    const projectB = b.cells[2].textContent;
                    return projectA.localeCompare(projectB);
                }
                return 0;
            });
            
            // Reorder the rows
            visibleRows.forEach(row => {
                tbody.appendChild(row);
            });
        }
        
        // Initial filter application
        applyFilters();
    });
</script>
{% endblock %}