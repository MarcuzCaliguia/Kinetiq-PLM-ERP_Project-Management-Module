{% extends "project_reports/base.html" %}

{% block title %}
    {% if report %}Edit Report{% else %}New Report{% endif %}
{% endblock %}

{% block content %}
<h2>{% if report %}Edit Report{% else %}New Report{% endif %}</h2>

<form method="post" id="reportForm">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
    <div class="error">
        {{ form.non_field_errors }}
    </div>
    {% endif %}
    
    <div class="form-group">
        <label for="id_project_id">Project ID:</label>
        {{ form.project_id }}
        <small class="form-text text-muted">Select an external project or leave blank if using internal project</small>
        {% if form.project_id.errors %}
        <div class="error">{{ form.project_id.errors }}</div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="id_intrnl_project_id">Internal Project ID:</label>
        {{ form.intrnl_project_id }}
        <small class="form-text text-muted">Select an internal project or leave blank if using external project</small>
        {% if form.intrnl_project_id.errors %}
        <div class="error">{{ form.intrnl_project_id.errors }}</div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="id_report_type">Report Type: <span class="required">*</span></label>
        {{ form.report_type }}
        {% if form.report_type.errors %}
        <div class="error">{{ form.report_type.errors }}</div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="id_report_title">Report Title: <span class="required">*</span></label>
        {{ form.report_title }}
        <small class="form-text text-muted">Enter a descriptive title for the report</small>
        {% if form.report_title.errors %}
        <div class="error">{{ form.report_title.errors }}</div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="id_received_from">Received From: <span class="required">*</span></label>
        {{ form.received_from }}
        {% if form.received_from.errors %}
        <div class="error">{{ form.received_from.errors }}</div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="id_date_created">Date Created: <span class="required">*</span></label>
        {{ form.date_created }}
        {% if form.date_created.errors %}
        <div class="error">{{ form.date_created.errors }}</div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="id_assigned_to">Assigned To: <span class="required">*</span></label>
        {{ form.assigned_to }}
        {% if form.assigned_to.errors %}
        <div class="error">{{ form.assigned_to.errors }}</div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="id_description">Description:</label>
        {{ form.description }}
        <small class="form-text text-muted">Provide any additional details about the report</small>
        {% if form.description.errors %}
        <div class="error">{{ form.description.errors }}</div>
        {% endif %}
    </div>
    
    <div style="margin-top: 20px;">
        <button type="submit" class="btn">Save</button>
        <a href="{% url 'project_reports:report_list' %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reportForm');
    const projectIdField = document.getElementById('id_project_id');
    const intrnlProjectIdField = document.getElementById('id_intrnl_project_id');
    
    // Make project selection mutually exclusive
    projectIdField.addEventListener('change', function() {
        if (this.value) {
            intrnlProjectIdField.value = '';
        }
    });
    
    intrnlProjectIdField.addEventListener('change', function() {
        if (this.value) {
            projectIdField.value = '';
        }
    });
    
    // Form validation
    form.addEventListener('submit', function(event) {
        let isValid = true;
        let errorMessage = '';
        
        // Validate required fields
        const requiredFields = [
            { id: 'id_report_type', name: 'Report Type' },
            { id: 'id_report_title', name: 'Report Title' },
            { id: 'id_received_from', name: 'Received From' },
            { id: 'id_date_created', name: 'Date Created' },
            { id: 'id_assigned_to', name: 'Assigned To' }
        ];
        
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element.value.trim()) {
                isValid = false;
                errorMessage += field.name + ' is required.\n';
                element.classList.add('error-field');
            } else {
                element.classList.remove('error-field');
            }
        });
        
        // Validate that at least one project ID is provided
        if (!projectIdField.value && !intrnlProjectIdField.value) {
            isValid = false;
            errorMessage += 'Either Project ID or Internal Project ID must be provided.\n';
            projectIdField.classList.add('error-field');
            intrnlProjectIdField.classList.add('error-field');
        } else {
            projectIdField.classList.remove('error-field');
            intrnlProjectIdField.classList.remove('error-field');
        }
        
        // Prevent form submission if validation fails
        if (!isValid) {
            event.preventDefault();
            alert('Please correct the following errors:\n\n' + errorMessage);
        }
    });
});
</script>

<style>
.required {
    color: red;
}
.error-field {
    border: 1px solid red !important;
}
.form-text {
    font-size: 0.875em;
    color: #6c757d;
}
</style>
{% endblock %}