<!-- project_tasks/templates/project_tasks/task_list.html -->
{% extends 'project_tasks/base.html' %}

{% block title %}Tasks{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Tasks</h1>
    <div>
        <a href="{% url 'internal_task_delete' 'placeholder' %}" class="btn btn-secondary me-2" id="deleteTaskBtn" style="display: none;">Delete Task</a>
        <a href="{% if task_type == 'external' %}{% url 'external_task_add' %}{% else %}{% url 'internal_task_add' %}{% endif %}" class="btn btn-primary">Add Task</a>
        <a href="{% url 'task_calendar' %}" class="btn btn-info me-2">
            <i class="fas fa-calendar-alt me-1"></i> Calendar
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <form method="get" id="searchForm">
                <input type="hidden" name="type" value="{{ task_type }}">
                <input type="text" class="form-control" name="search" placeholder="Search tasks..." value="{{ search_query }}">
            </form>
        </div>
    </div>
    <div class="col-md-6">
        <ul class="nav nav-tabs tab-nav">
            <li class="nav-item">
                <a class="nav-link {% if task_type == 'all' %}active{% endif %}" href="{% url 'task_list' %}?type=all">All</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if task_type == 'internal' %}active{% endif %}" href="{% url 'task_list' %}?type=internal">Internal Tasks</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if task_type == 'external' %}active{% endif %}" href="{% url 'task_list' %}?type=external">External Tasks</a>
            </li>
        </ul>
    </div>
</div>

<div class="table-responsive">
    <table class="table task-table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" class="form-check-input">
                </th>
                <th>Tasks ID</th>
                <th>Status</th>
                <th>Project ID</th>
                <th>Deadline</th>
                <th>Description</th>
                <th>Purchase Request ID</th>
                <th>Dependencies</th>
                <th>Employee ID</th>
                <th style="width: 40px;"></th>
                <th style="width: 40px;"></th>
            </tr>
        </thead>
        <tbody>
            {% if task_type == 'all' %}
                {% for task in tasks %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input task-checkbox" data-id="{{ task.id }}" data-type="{{ task.type }}">
                        </td>
                        <td>{{ task.id }}</td>
                        <td>
                            <span class="status-badge status-{{ task.status|lower|slugify }}">
                                {{ task.status|title }}
                            </span>
                        </td>
                        <td>{{ task.project_id }}</td>
                        <td>{{ task.deadline|date:"M d, Y" }}</td>
                        <td>{{ task.description|default:"None" }}</td>
                        <td>{{ task.project_id|default:"" }}</td>
                        <td>{{ task.description|default:"" }}</td>
                        <td>{{ task.assigned_to|default:"" }}</td>
                        <td>
                            <button type="button" class="info-circle-button" onclick="showTaskInfo('{{ task.id }}', '{{ task.type }}', '{{ task.status }}', '{{ task.project_id }}', '{{ task.deadline|date:'Y-m-d' }}', '{{ task.description|escapejs }}', '{{ task.assigned_to|default:'Unassigned'|escapejs }}')">
                                <i class="fas fa-info"></i>
                            </button>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="action-button" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="{% if task.type == 'internal' %}{% url 'internal_task_detail' task.id %}{% else %}{% url 'external_task_detail' task.id %}{% endif %}">
                                            <i class="fas fa-eye me-2"></i> View
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% if task.type == 'internal' %}{% url 'internal_task_edit' task.id %}{% else %}{% url 'external_task_edit' task.id %}{% endif %}">
                                            <i class="fas fa-edit me-2"></i> Edit
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% if task.type == 'internal' %}{% url 'internal_task_delete' task.id %}{% else %}{% url 'external_task_delete' task.id %}{% endif %}">
                                            <i class="fas fa-trash me-2"></i> Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="11" class="text-center py-4">No tasks found</td>
                    </tr>
                {% endfor %}
            {% elif task_type == 'internal' %}
                {% for task in tasks %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input task-checkbox" data-id="{{ task.intrnl_task_id }}" data-type="internal">
                        </td>
                        <td>{{ task.intrnl_task_id }}</td>
                        <td>
                            <span class="status-badge status-{{ task.intrnl_task_status|lower|slugify }}">
                                {{ task.intrnl_task_status|title }}
                            </span>
                        </td>
                        <td>{{ task.intrnl_project.intrnl_project_id|default:"N/A" }}</td>
                        <td>{{ task.intrnl_task_deadline|date:"M d, Y" }}</td>
                        <td>{{ task.intrnl_task_description|default:"None" }}</td>
                        <td>{{ task.intrnl_project.intrnl_project_id|default:"" }}</td>
                        <td>{{ task.intrnl_task_description|default:"" }}</td>
                        <td>{{ task.intrnl_project_labor.employee_id|default:"" }}</td>
                        <td>
                            <button type="button" class="info-circle-button" onclick="showTaskInfo('{{ task.intrnl_task_id }}', 'internal', '{{ task.intrnl_task_status }}', '{{ task.intrnl_project.intrnl_project_id|default:'N/A' }}', '{{ task.intrnl_task_deadline|date:'Y-m-d' }}', '{{ task.intrnl_task_description|escapejs }}', '{{ task.assigned_employee|default:'Unassigned'|escapejs }}')">
                                <i class="fas fa-info"></i>
                            </button>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="action-button" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="{% url 'internal_task_detail' task.intrnl_task_id %}">
                                            <i class="fas fa-eye me-2"></i> View
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'internal_task_edit' task.intrnl_task_id %}">
                                            <i class="fas fa-edit me-2"></i> Edit
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'internal_task_delete' task.intrnl_task_id %}">
                                            <i class="fas fa-trash me-2"></i> Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="11" class="text-center py-4">No internal tasks found</td>
                    </tr>
                {% endfor %}
            {% else %}
                {% for task in tasks %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input task-checkbox" data-id="{{ task.task_id }}" data-type="external">
                        </td>
                        <td>{{ task.task_id }}</td>
                        <td>
                            <span class="status-badge status-{{ task.task_status|lower|slugify }}">
                                {{ task.task_status|title }}
                            </span>
                        </td>
                        <td>{{ task.project.project_id|default:"N/A" }}</td>
                        <td>{{ task.task_deadline|date:"M d, Y" }}</td>
                        <td>{{ task.task_description|default:"None" }}</td>
                        <td>{{ task.project.project_id|default:"00000" }}</td>
                        <td>{{ task.task_description|default:"" }}</td>
                        <td>{{ task.project_labor.employee_id|default:"00000" }}</td>
                        <td>
                            <button type="button" class="info-circle-button" onclick="showTaskInfo('{{ task.task_id }}', 'external', '{{ task.task_status }}', '{{ task.project.project_id|default:'N/A' }}', '{{ task.task_deadline|date:'Y-m-d' }}', '{{ task.task_description|escapejs }}', '{{ task.assigned_employee|default:'Unassigned'|escapejs }}')">
                                <i class="fas fa-info"></i>
                            </button>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="action-button" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="{% url 'external_task_detail' task.task_id %}">
                                            <i class="fas fa-eye me-2"></i> View
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'external_task_edit' task.task_id %}">
                                            <i class="fas fa-edit me-2"></i> Edit
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'external_task_delete' task.task_id %}">
                                            <i class="fas fa-trash me-2"></i> Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="11" class="text-center py-4">No external tasks found</td>
                    </tr>
                {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Task Info Modal -->
<div class="modal fade" id="taskInfoModal" tabindex="-1" aria-labelledby="taskInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskInfoModalLabel">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Task ID:</div>
                    <div class="col-md-9" id="modal-task-id"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Status:</div>
                    <div class="col-md-9" id="modal-task-status"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Project ID:</div>
                    <div class="col-md-9" id="modal-project-id"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Deadline:</div>
                    <div class="col-md-9" id="modal-deadline"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Description:</div>
                    <div class="col-md-9" id="modal-description"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Assigned To:</div>
                    <div class="col-md-9" id="modal-assigned-to"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="modal-edit-link">Edit Task</a>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal -->
<div class="modal fade" id="fileUploadModal" tabindex="-1" aria-labelledby="fileUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileUploadModalLabel">Upload Attachments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="fileUploadForm" enctype="multipart/form-data" method="post" action="#">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="taskSelector" class="form-label">Select Task</label>
                        <select class="form-select" id="taskSelector" name="task_id" required>
                            <option value="">-- Select a task --</option>
                            {% if task_type == 'all' or task_type == 'internal' %}
                                <optgroup label="Internal Tasks">
                                    {% for task in tasks %}
                                        {% if task_type == 'all' %}
                                            {% if task.type == 'internal' %}
                                                <option value="{{ task.id }}">{{ task.id }} - {{ task.description|truncatechars:30 }}</option>
                                            {% endif %}
                                        {% else %}
                                            <option value="{{ task.intrnl_task_id }}">{{ task.intrnl_task_id }} - {{ task.intrnl_task_description|truncatechars:30 }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                            
                            {% if task_type == 'all' or task_type == 'external' %}
                                <optgroup label="External Tasks">
                                    {% for task in tasks %}
                                        {% if task_type == 'all' %}
                                            {% if task.type == 'external' %}
                                                <option value="{{ task.id }}">{{ task.id }} - {{ task.description|truncatechars:30 }}</option>
                                            {% endif %}
                                        {% else %}
                                            <option value="{{ task.task_id }}">{{ task.task_id }} - {{ task.task_description|truncatechars:30 }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fileDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="fileDescription" name="description" placeholder="Optional description for the file">
                    </div>
                    
                    <div class="mb-4">
                        <div class="file-upload-container" id="dropZone">
                            <div class="text-center p-5">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                <p class="mb-2">Drag and drop files here</p>
                                <p class="text-muted small">or</p>
                                <label for="fileInput" class="btn btn-outline-primary">Browse Files</label>
                                <input type="file" id="fileInput" name="files" multiple style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div id="filePreviewContainer" class="mb-3" style="display: none;">
                        <h6>Selected Files:</h6>
                        <ul id="filePreviewList" class="list-group">
                            <!-- File previews will be added here -->
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="uploadButton">Upload Files</button>
            </div>
        </div>
    </div>
</div>

<div class="mt-4 border-top pt-3">
    <div class="d-flex justify-content-between">
        <h5>Attachments</h5>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#fileUploadModal">Attach File</button>
    </div>
    
    <!-- Display attachments if any -->
    <div id="attachments-container" class="mt-3">
        <div class="list-group">
            <!-- This is a placeholder. In a real app, you would loop through attachments from the database -->
            <!-- Example attachment item -->
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-file-pdf me-2 text-danger"></i>
                    <span>Sample Document.pdf</span>
                    <small class="text-muted ms-2">(2.5 MB)</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-1">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Add custom styling for the table */
    .table-responsive {
        overflow-x: auto;
        max-width: 100%;
    }
    
    /* Add some minimum width to columns to prevent them from becoming too narrow */
    .task-table th, .task-table td {
        min-width: 100px;
        white-space: nowrap;
    }
    
    /* Make some columns wider for better readability */
    .task-table th:nth-child(6), .task-table td:nth-child(6),
    .task-table th:nth-child(8), .task-table td:nth-child(8) {
        min-width: 200px;
        max-width: 300px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Make checkbox and action columns narrower */
    .task-table th:first-child, .task-table td:first-child,
    .task-table th:nth-last-child(1), .task-table td:nth-last-child(1),
    .task-table th:nth-last-child(2), .task-table td:nth-last-child(2) {
        min-width: 40px;
    }
    
    /* Style for the info circle button to match your UI */
    .info-circle-button {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        padding: 0;
    }
    
    .info-circle-button:hover {
        background-color: #5a6268;
    }
    
    .info-circle-button i {
        font-size: 12px;
    }
    
    /* Style for status badge in modal */
    #modal-task-status .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        color: white;
        font-size: 0.8rem;
    }
    
    /* File upload styles */
    .file-upload-container {
        border: 2px dashed #ccc;
        border-radius: 5px;
        background-color: #f8f9fa;
        transition: all 0.3s;
    }
    
    .file-upload-container.highlight {
        border-color: #00bcd4;
        background-color: #e0f7fa;
    }
    
    .file-preview-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .file-preview-item .file-icon {
        font-size: 24px;
        margin-right: 10px;
    }
    
    .file-preview-item .file-name {
        flex-grow: 1;
    }
    
    .file-preview-item .file-size {
        color: #6c757d;
        margin-right: 10px;
    }
    
    .file-preview-item .file-remove {
        cursor: pointer;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Handle search form submission
        $('#searchForm input[name="search"]').on('keyup', function() {
            if ($(this).val().length > 2 || $(this).val().length === 0) {
                $('#searchForm').submit();
            }
        });
        
        // Handle select all checkbox
        $('#selectAll').change(function() {
            $('.task-checkbox').prop('checked', $(this).prop('checked'));
            updateDeleteButton();
        });
        
        // Handle individual checkboxes
        $('.task-checkbox').change(function() {
            updateDeleteButton();
        });
        
        // Update delete button visibility
        function updateDeleteButton() {
            if ($('.task-checkbox:checked').length > 0) {
                $('#deleteTaskBtn').show();
                
                // Update the delete button URL based on the first selected task
                var firstChecked = $('.task-checkbox:checked').first();
                var taskId = firstChecked.data('id');
                var taskType = firstChecked.data('type');
                
                var deleteUrl = taskType === 'internal' 
                    ? "{% url 'internal_task_delete' 'placeholder' %}".replace('placeholder', taskId)
                    : "{% url 'external_task_delete' 'placeholder' %}".replace('placeholder', taskId);
                
                $('#deleteTaskBtn').attr('href', deleteUrl);
            } else {
                $('#deleteTaskBtn').hide();
            }
        }
        
// File Upload Functionality
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const filePreviewContainer = document.getElementById('filePreviewContainer');
const filePreviewList = document.getElementById('filePreviewList');
const uploadButton = document.getElementById('uploadButton');
let selectedFiles = [];

// File type and size restrictions
const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100 MB in bytes
const ALLOWED_FILE_TYPES = [
    // Images
    'image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/webp', 'image/tiff',
    // Documents
    'application/pdf', 
    'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // Word
    'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // Excel
    'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation', // PowerPoint
    'text/plain', 'text/csv', 'text/html', 'text/rtf'
];

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropZone.classList.add('highlight');
}

function unhighlight() {
    dropZone.classList.remove('highlight');
}

// Handle dropped files
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

// Handle selected files from file input
fileInput.addEventListener('change', function() {
    handleFiles(this.files);
});

function handleFiles(files) {
    if (files.length > 0) {
        filePreviewContainer.style.display = 'block';
    }
    
    Array.from(files).forEach(file => {
        // Check if file is already selected
        if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
            showAlert('warning', `File "${file.name}" is already selected.`);
            return;
        }
        
        // Check file type
        if (!ALLOWED_FILE_TYPES.includes(file.type)) {
            showAlert('danger', `File "${file.name}" is not allowed. Only documents and images are permitted.`);
            return;
        }
        
        // Check file size
        if (file.size > MAX_FILE_SIZE) {
            showAlert('danger', `File "${file.name}" exceeds the maximum size limit of 100 MB.`);
            return;
        }
        
        // Add file to selected files
        selectedFiles.push(file);
        addFilePreview(file);
    });
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Insert alert before the file upload container
    dropZone.parentNode.insertBefore(alertDiv, dropZone);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
    }, 5000);
}

function addFilePreview(file) {
    const fileItem = document.createElement('li');
    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
    
    // Determine file icon based on file type
    let fileIcon = 'fa-file';
    const fileType = file.type.split('/')[0];
    const fileExt = file.name.split('.').pop().toLowerCase();
    
    if (fileType === 'image') {
        fileIcon = 'fa-file-image text-primary';
    } else if (fileExt === 'pdf') {
        fileIcon = 'fa-file-pdf text-danger';
    } else if (['doc', 'docx'].includes(fileExt)) {
        fileIcon = 'fa-file-word text-primary';
    } else if (['xls', 'xlsx'].includes(fileExt)) {
        fileIcon = 'fa-file-excel text-success';
    } else if (['ppt', 'pptx'].includes(fileExt)) {
        fileIcon = 'fa-file-powerpoint text-warning';
    } else if (['txt', 'rtf', 'csv'].includes(fileExt)) {
        fileIcon = 'fa-file-alt text-secondary';
    }
    
    // Format file size
    const fileSize = formatFileSize(file.size);
    
    fileItem.innerHTML = `
        <div>
            <i class="fas ${fileIcon} me-2"></i>
            <span>${file.name}</span>
            <small class="text-muted ms-2">(${fileSize})</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger remove-file" data-filename="${file.name}">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    filePreviewList.appendChild(fileItem);
    
    // Add event listener to remove button
    fileItem.querySelector('.remove-file').addEventListener('click', function() {
        const fileName = this.getAttribute('data-filename');
        removeFile(fileName);
        fileItem.remove();
        
        if (selectedFiles.length === 0) {
            filePreviewContainer.style.display = 'none';
        }
    });
}

function removeFile(fileName) {
    selectedFiles = selectedFiles.filter(file => file.name !== fileName);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Calculate total size of selected files
function getTotalSize() {
    return selectedFiles.reduce((total, file) => total + file.size, 0);
}

// Handle file upload
uploadButton.addEventListener('click', function() {
    if (selectedFiles.length === 0) {
        showAlert('warning', 'Please select at least one file to upload.');
        return;
    }
    
    const taskId = document.getElementById('taskSelector').value;
    if (!taskId) {
        showAlert('warning', 'Please select a task to attach files to.');
        return;
    }
    
    // Check total size
    const totalSize = getTotalSize();
    if (totalSize > MAX_FILE_SIZE) {
        showAlert('danger', `Total file size (${formatFileSize(totalSize)}) exceeds the maximum limit of 100 MB.`);
        return;
    }
    
    const formData = new FormData();
    formData.append('task_id', taskId);
    formData.append('description', document.getElementById('fileDescription').value);
    
    selectedFiles.forEach((file, index) => {
        formData.append(`file_${index}`, file);
    });
    
    // In a real application, you would send this form data to the server using AJAX
    // For demonstration purposes, we'll simulate a successful upload
    
    // Simulate upload with a loading state
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
    
    // Simulate network delay
    setTimeout(function() {
        // Reset the form and close the modal
        document.getElementById('fileUploadForm').reset();
        filePreviewList.innerHTML = '';
        filePreviewContainer.style.display = 'none';
        
        // Store files temporarily for display
        const uploadedFiles = [...selectedFiles];
        selectedFiles = [];
        
        // Add the uploaded files to the attachments list (in a real app this would come from the server)
        const attachmentsContainer = document.getElementById('attachments-container');
        const listGroup = attachmentsContainer.querySelector('.list-group');
        
        // Clear any existing sample attachments
        listGroup.innerHTML = '';
        
        uploadedFiles.forEach(file => {
            const fileExt = file.name.split('.').pop().toLowerCase();
            let fileIcon = 'fa-file';
            
            if (file.type.startsWith('image/')) {
                fileIcon = 'fa-file-image text-primary';
            } else if (fileExt === 'pdf') {
                fileIcon = 'fa-file-pdf text-danger';
            } else if (['doc', 'docx'].includes(fileExt)) {
                fileIcon = 'fa-file-word text-primary';
            } else if (['xls', 'xlsx'].includes(fileExt)) {
                fileIcon = 'fa-file-excel text-success';
            } else if (['ppt', 'pptx'].includes(fileExt)) {
                fileIcon = 'fa-file-powerpoint text-warning';
            } else if (['txt', 'rtf', 'csv'].includes(fileExt)) {
                fileIcon = 'fa-file-alt text-secondary';
            }
            
            const fileSize = formatFileSize(file.size);
            
            const attachmentItem = document.createElement('div');
            attachmentItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            attachmentItem.innerHTML = `
                <div>
                    <i class="fas ${fileIcon} me-2"></i>
                    <span>${file.name}</span>
                    <small class="text-muted ms-2">(${fileSize})</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-1">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            listGroup.appendChild(attachmentItem);
        });
        
        // Show success message
        showAlert('success', `${uploadedFiles.length} file(s) uploaded successfully.`);
        
        // Reset button state
        uploadButton.disabled = false;
        uploadButton.innerHTML = 'Upload Files';
        
        // Close the modal
        const fileUploadModal = bootstrap.Modal.getInstance(document.getElementById('fileUploadModal'));
        fileUploadModal.hide();
    }, 2000);
});
</script>
{% endblock %}