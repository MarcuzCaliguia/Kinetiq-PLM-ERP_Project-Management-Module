{% extends 'project_tasks/base.html' %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' rel='stylesheet' />
<style>
    #calendar {
        max-width: 1000px;
        margin: 0 auto;
    }
    .fc-event {
        cursor: pointer;
    }
    .event-tooltip {
        max-width: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Task Calendar</h1>
        <div>
            <a href="{% url 'task_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-list-ul me-1"></i> List View
            </a>
            <div class="btn-group ms-2">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-plus-lg me-1"></i> Add Task
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'new_internal_task' %}">Internal Task</a></li>
                    <li><a class="dropdown-item" href="{% url 'new_external_task' %}">External Task</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventTitle">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventBody">
                <div class="mb-3">
                    <strong>Description:</strong>
                    <p id="eventDescription"></p>
                </div>
                <div class="mb-3">
                    <strong>Deadline:</strong>
                    <p id="eventDate"></p>
                </div>
                <div class="mb-3">
                    <strong>Status:</strong>
                    <span id="eventStatus" class="badge"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewTaskBtn" class="btn btn-primary">View Task</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        
        // Parse events from JSON
        const events = {{ events_json|safe }};
        
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listMonth'
            },
            events: events,
            eventClick: function(info) {
                // Prevent navigating to the URL
                info.jsEvent.preventDefault();
                
                // Set modal content
                document.getElementById('eventTitle').textContent = info.event.title;
                document.getElementById('eventDescription').textContent = info.event.extendedProps.description || 'No description';
                document.getElementById('eventDate').textContent = info.event.start.toLocaleDateString();
                
                // Set status badge
                const statusBadge = document.getElementById('eventStatus');
                statusBadge.textContent = info.event.backgroundColor === '#ffc107' ? 'Pending' :
                                         info.event.backgroundColor === '#0d6efd' ? 'In Progress' :
                                         info.event.backgroundColor === '#198754' ? 'Completed' : 'Cancelled';
                                         
                statusBadge.className = 'badge';
                statusBadge.classList.add(info.event.backgroundColor === '#ffc107' ? 'bg-warning' :
                                         info.event.backgroundColor === '#0d6efd' ? 'bg-primary' :
                                         info.event.backgroundColor === '#198754' ? 'bg-success' : 'bg-secondary');
                
                // Set view task button URL
                document.getElementById('viewTaskBtn').href = info.event.url;
                
                // Show modal
                eventModal.show();
            }
        });
        
        calendar.render();
    });
</script>
{% endblock %}