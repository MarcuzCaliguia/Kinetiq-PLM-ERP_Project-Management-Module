<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Planning</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css" rel="stylesheet">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fc;
        }
        .card {
            border: none;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
        }
        .font-weight-bold {
            font-weight: 700 !important;
        }
        .text-primary {
            color: #4e73df !important;
        }
        .badge-project-type {
            padding: 5px 10px;
            border-radius: 30px;
            font-size: 12px;
        }
        .badge-external {
            background-color: #4e73df;
            color: white;
        }
        .badge-internal {
            background-color: #1cc88a;
            color: white;
        }
        .project-type-selector {
            margin-bottom: 20px;
        }
        .project-type-selector .btn {
            border-radius: 30px;
            margin-right: 10px;
            padding: 8px 20px;
        }
        .project-type-selector .btn.active {
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }
        .stats-card {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-card-total {
            background-color: #4e73df;
        }
        .stats-card-external {
            background-color: #1cc88a;
        }
        .stats-card-internal {
            background-color: #36b9cc;
        }
        .stats-card-icon {
            font-size: 2rem;
            opacity: 0.7;
        }
        .stats-card-count {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .stats-card-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Project Planning</h1>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}

        {% if error %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
        {% endif %}

        <!-- Project Stats -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card stats-card-total">
                    <div>
                        <div class="stats-card-title">Total Projects</div>
                        <div class="stats-card-count">{{ total_count }}</div>
                    </div>
                    <div class="stats-card-icon">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card stats-card-external">
                    <div>
                        <div class="stats-card-title">External Projects</div>
                        <div class="stats-card-count">{{ external_count }}</div>
                    </div>
                    <div class="stats-card-icon">
                        <i class="fas fa-building"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card stats-card-internal">
                    <div>
                        <div class="stats-card-title">Internal Projects</div>
                        <div class="stats-card-count">{{ internal_count }}</div>
                    </div>
                    <div class="stats-card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
<!-- Tabs -->
<!-- Tabs -->
<!-- Tabs -->
<ul class="nav nav-tabs" id="projectTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="new-plan-tab" data-toggle="tab" href="#new-plan" role="tab" aria-controls="new-plan" aria-selected="true">New Project Plan</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="project-list-tab" data-toggle="tab" href="#project-list" role="tab" aria-controls="project-list" aria-selected="false">Project List</a>
    </li>
    <li class="nav-item">
        <!-- Remove all tab-related attributes -->
        <a class="nav-link" id="schedule-link" href="/tasks/calendar/">Schedule</a>
    </li>
</ul>
        <!-- Tab content -->
        <div class="tab-content" id="projectTabsContent">
            <!-- New Project Plan Tab -->
            <div class="tab-pane fade show active" id="new-plan" role="tabpanel" aria-labelledby="new-plan-tab">
                <div class="card shadow mb-4 mt-3">
                    <div class="card-body">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="create">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="project_type">Project Type*</label>
                                        <select class="form-control" id="project_type" name="project_type" required>
                                            <option value="External">External Project</option>
                                            <option value="Internal">Internal Project</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="project_name">Project Name*</label>
                                        <input type="text" class="form-control" id="project_name" name="project_name" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="project_request_id">Project Request</label>
                                        <select class="form-control" id="project_request_id" name="project_request_id">
                                            <option value="">Select Project Request</option>
                                            <optgroup label="External Projects" id="external_requests">
                                                {% for request in external_requests %}
                                                    <option value="{{ request.request_id }}" data-type="External">{{ request.project_name }}</option>
                                                {% endfor %}
                                            </optgroup>
                                            <optgroup label="Internal Projects" id="internal_requests">
                                                {% for request in internal_requests %}
                                                    <option value="{{ request.request_id }}" data-type="Internal">{{ request.project_name }}</option>
                                                {% endfor %}
                                            </optgroup>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row warranty-fields">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="warranty_coverage_yr">Warranty Coverage (Years)*</label>
                                        <input type="number" class="form-control" id="warranty_coverage_yr" name="warranty_coverage_yr" min="1" value="1" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="start_date">Start Date*</label>
                                        <input type="date" class="form-control" id="start_date" name="start_date" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="end_date">End Date*</label>
                                        <input type="date" class="form-control" id="end_date" name="end_date" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 progress-field">
                                    <div class="form-group">
                                        <label for="progress">Progress/Milestone*</label>
                                        <select class="form-control" id="progress" name="progress" required>
                                            <option value="Not Started">Not Started</option>
                                            <option value="Planning">Planning</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Testing">Testing</option>
                                            <option value="Completed">Completed</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="project_issue">Project Issues</label>
                                <textarea class="form-control" id="project_issue" name="project_issue" rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="description">Project Requirements</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="project_details" checked>
                                    <label class="form-check-label" for="project_details">
                                        Project Details
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="objectives_goals" checked>
                                    <label class="form-check-label" for="objectives_goals">
                                        Objective And Goals
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="file_document" checked>
                                    <label class="form-check-label" for="file_document">
                                        File And Document Completion
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="requirements" checked>
                                    <label class="form-check-label" for="requirements">
                                        Requirements Completion
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="add_description">Add Description</label>
                                <textarea class="form-control" id="add_description" name="add_description" rows="3"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary float-right">Create Plan</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Project List Tab -->
            <div class="tab-pane fade" id="project-list" role="tabpanel" aria-labelledby="project-list-tab">
                <!-- Debug information -->
                 
                <div class="card shadow mb-4 mt-3">
                    <div class="card-body">
                        <div class="project-type-selector btn-group mb-4" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-filter="all">All Projects ({{ total_count }})</button>
                            <button type="button" class="btn btn-outline-success" data-filter="External">External Projects ({{ external_count }})</button>
                            <button type="button" class="btn btn-outline-info" data-filter="Internal">Internal Projects ({{ internal_count }})</button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered" id="projectsTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Tracking ID</th>
                                        <th>Project Name</th>
                                        <th>Type</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Status/Milestone</th>
                                        <th>Warranty</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in projects %}
                                    <tr class="project-row" data-type="{{ project.project_type }}">
                                        <td>{{ project.project_tracking_id }}</td>
                                        <td>{{ project.project_name|default:"Unnamed Project" }}</td>
                                        <td>
                                            <span class="badge badge-project-type badge-{{ project.project_type|lower }}">
                                                {{ project.project_type }}
                                            </span>
                                        </td>
                                        <td>{{ project.start_date|date:"Y-m-d" }}</td>
                                        <td>{{ project.estimated_end_date|date:"Y-m-d" }}</td>
                                        <td>
                                            {% if project.project_type == 'External' %}
                                                {{ project.project_milestone|default:"Not specified" }}
                                            {% else %}
                                                {{ project.project_status|default:"Not specified" }}
                                            {% endif %}
                                        </td>
                                        <td class="warranty-column">
                                            {% if project.project_type == 'External' and project.warranty_coverage_yr %}
                                                {{ project.warranty_coverage_yr }} year(s)
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#editModal{{ forloop.counter }}">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center">No projects found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                <div class="card shadow mb-4 mt-3">
                    <div class="card-body">
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Project Modals -->
        {% for project in projects %}
        <div class="modal fade" id="editModal{{ forloop.counter }}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel{{ forloop.counter }}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel{{ forloop.counter }}">Edit Project: {{ project.project_name }}</h5>                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="update">
                            <input type="hidden" name="tracking_id" value="{{ project.project_tracking_id }}">
                            <input type="hidden" name="project_type" value="{{ project.project_type }}">
                            
                            {% if project.project_type == 'External' %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="warranty_coverage_yr{{ forloop.counter }}">Warranty Coverage (Years)*</label>
                                        <input type="number" class="form-control" id="warranty_coverage_yr{{ forloop.counter }}" name="warranty_coverage_yr" min="1" value="{{ project.warranty_coverage_yr|default:'1' }}" required>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="start_date{{ forloop.counter }}">Start Date*</label>
                                        <input type="date" class="form-control" id="start_date{{ forloop.counter }}" name="start_date" value="{{ project.start_date|date:'Y-m-d' }}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="end_date{{ forloop.counter }}">End Date*</label>
                                        <input type="date" class="form-control" id="end_date{{ forloop.counter }}" name="end_date" value="{{ project.estimated_end_date|date:'Y-m-d' }}" required>
                                    </div>
                                </div>
                            </div>

                            {% if project.project_type == 'External' %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="progress{{ forloop.counter }}">Progress/Milestone*</label>
                                        <select class="form-control" id="progress{{ forloop.counter }}" name="progress" required>
                                            <option value="Not Started" {% if project.project_milestone == 'Not Started' %}selected{% endif %}>Not Started</option>
                                            <option value="Planning" {% if project.project_milestone == 'Planning' %}selected{% endif %}>Planning</option>
                                            <option value="In Progress" {% if project.project_milestone == 'In Progress' %}selected{% endif %}>In Progress</option>
                                            <option value="Testing" {% if project.project_milestone == 'Testing' %}selected{% endif %}>Testing</option>
                                            <option value="Completed" {% if project.project_milestone == 'Completed' %}selected{% endif %}>Completed</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="form-group">
                                <label for="project_issue{{ forloop.counter }}">Project Issues</label>
                                <textarea class="form-control" id="project_issue{{ forloop.counter }}" name="project_issue" rows="3">{{ project.project_issue }}</textarea>
                            </div>

                            <button type="submit" class="btn btn-primary float-right">Update Plan</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- jQuery, Bootstrap, and DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Initialize DataTable - only initialize once
            var projectsTable;
            
            if (!$.fn.DataTable.isDataTable('#projectsTable')) {
                projectsTable = $('#projectsTable').DataTable({
                    "order": [[ 0, "desc" ]],
                    "pageLength": 10,
                    "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                    "columnDefs": [
                        {
                            "targets": 6, // Warranty column index
                            "className": "warranty-column"
                        }
                    ]
                });
            } else {
                projectsTable = $('#projectsTable').DataTable();
            }
            
            // Project type filter buttons
            $('.project-type-selector .btn').on('click', function() {
                var filterValue = $(this).data('filter');
                
                // Update active button
                $('.project-type-selector .btn').removeClass('active');
                $(this).addClass('active');
                
                // Apply filter to DataTable
                if (filterValue === 'all') {
                    projectsTable.columns(2).search('').draw();
                    // Show warranty column for mixed results
                    $('.warranty-column').show();
                } else {
                    projectsTable.columns(2).search(filterValue).draw();
                    // Hide warranty column for internal projects only
                    if (filterValue === 'Internal') {
                        $('.warranty-column').hide();
                    } else {
                        $('.warranty-column').show();
                    }
                }
            });
            
            // Toggle warranty fields based on project type
            $('#project_type').on('change', function() {
                var projectType = $(this).val();
                if (projectType === 'Internal') {
                    $('.warranty-fields').hide();
                } else {
                    $('.warranty-fields').show();
                }
                
                // Filter the project request dropdown options
                $('#project_request_id option').each(function() {
                    var optionType = $(this).data('type');
                    if (!optionType || optionType === projectType) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });
            
            // Initialize Calendar
            var calendarInitialized = false;
            $('#schedule-tab').on('shown.bs.tab', function (e) {
                if (!calendarInitialized) {
                    var calendarEl = document.getElementById('calendar');
                    if (calendarEl) {
                        var calendar = new FullCalendar.Calendar(calendarEl, {
                            initialView: 'dayGridMonth',
                            headerToolbar: {
                                left: 'prev,next today',
                                center: 'title',
                                right: 'dayGridMonth,timeGridWeek,timeGridDay'
                            },
                            events: [
                            {% for project in projects %}
                            {
                                title: '{{ project.project_name }}',
                                start: '{{ project.start_date|date:"Y-m-d" }}',
                                end: '{{ project.estimated_end_date|date:"Y-m-d" }}',
                                url: '#editModal{{ forloop.counter }}',
                                color: '{% if project.project_type == "External" %}#4e73df{% else %}#1cc88a{% endif %}'
                            },
                            {% endfor %}
                            ],
                            eventClick: function(info) {
                                info.jsEvent.preventDefault();
                                $(info.event.url).modal('show');
                            }
                        });
                        calendar.render();
                        calendarInitialized = true;
                    }
                }
            });
            
            // Set today's date as default for start_date
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var yyyy = today.getFullYear();
            today = yyyy + '-' + mm + '-' + dd;
            
            $('#start_date').val(today);
            
            // Set default end date as 1 year from today
            var endDate = new Date();
            endDate.setFullYear(endDate.getFullYear() + 1);
            var endDd = String(endDate.getDate()).padStart(2, '0');
            var endMm = String(endDate.getMonth() + 1).padStart(2, '0');
            var endYyyy = endDate.getFullYear();
            endDateStr = endYyyy + '-' + endMm + '-' + endDd;
            
            $('#end_date').val(endDateStr);
            
            // Trigger the project type change event on load
            $('#project_type').trigger('change');
        });

// Add this to your existing script section
$(document).ready(function() {
    // Add direct click handler to the schedule link
    $('#schedule-link').on('click', function(e) {
        // Prevent default tab behavior
        e.preventDefault();
        // Redirect to calendar
        window.location.href = '/tasks/calendar/';
        return false;
    });
});
    </script>
</body>
</html>